<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelab Agent - –£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.agent {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.agent .message-bubble {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 0 10px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            color: white;
        }

        .message.agent .message-avatar {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input input:focus {
            border-color: #6366f1;
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6366f1;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
        .formatted-text h1, .formatted-text h2, .formatted-text h3 {
            margin: 10px 0;
            font-weight: 600;
        }

        .formatted-text h1 { font-size: 18px; }
        .formatted-text h2 { font-size: 16px; }
        .formatted-text h3 { font-size: 14px; }

        .formatted-text code {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .formatted-text ul, .formatted-text ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .formatted-text li {
            margin: 5px 0;
        }

        .formatted-text strong {
            font-weight: 600;
        }

        .formatted-text em {
            font-style: italic;
        }

        .formatted-text blockquote {
            border-left: 3px solid rgba(255,255,255,0.3);
            padding-left: 15px;
            margin: 10px 0;
            font-style: italic;
        }

        .formatted-text hr {
            border: none;
            border-top: 1px solid rgba(255,255,255,0.3);
            margin: 15px 0;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è RAG –ø–æ–ª–µ–π */
        .rag-fields {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .field-group {
            margin-bottom: 15px;
        }

        .field-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .field-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .rag-controls {
            margin-top: 15px;
            text-align: center;
        }

        .toggle-rag {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .toggle-rag:hover {
            transform: translateY(-1px);
        }

        .file-upload {
            margin-top: 15px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 10px;
            border: 1px solid #f59e0b;
        }

        .file-upload label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: #92400e;
        }

        .file-upload input[type="file"] {
            margin-bottom: 10px;
        }

        .upload-button {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .upload-button:hover {
            transform: translateY(-1px);
        }

        #uploadStatus {
            margin-top: 10px;
            font-size: 14px;
            color: #059669;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ü§ñ Homelab Agent</h1>
            <p>–£–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–µ–π</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message agent">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble">
                    –ü—Ä–∏–≤–µ—Ç! –Ø Homelab Agent - –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ó–∞–¥–∞–π—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ –ø–æ–≥–æ–¥–µ, –Ω–æ–≤–æ—Å—Ç—è—Ö, —Å—Ç–∞—Ç—É—Å–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–ê–≥–µ–Ω—Ç –¥—É–º–∞–µ—Ç...</p>
        </div>
        
        <div class="chat-input">
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." maxlength="500">
                <button class="send-button" id="sendButton" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            
            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è RAG -->
            <div class="rag-fields" id="ragFields" style="display: none;">
                <div class="field-group">
                    <label for="composeInput">Docker Compose (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <textarea id="composeInput" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ docker-compose.yml –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞..."></textarea>
                </div>
                <div class="field-group">
                    <label for="proxyInput">–ü—Ä–æ–∫—Å–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <textarea id="proxyInput" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Caddy/Traefik..."></textarea>
                </div>
            </div>
            
            <div class="rag-controls">
                <button type="button" class="toggle-rag" onclick="toggleRagFields()">
                    üìÅ –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                </button>
            </div>
            
            <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è RAG -->
            <div class="file-upload">
                <label for="fileInput">üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:</label>
                <input type="file" id="fileInput" multiple accept=".txt,.md,.yml,.yaml,.log,.py,.js,.sh">
                <button type="button" class="upload-button" onclick="uploadFiles()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <div id="uploadStatus"></div>
            </div>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loading = document.getElementById('loading');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        messageInput.focus();

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addMessage(message, 'user');
            messageInput.value = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loading.classList.add('show');
            sendButton.disabled = true;

            // –°–æ–±–∏—Ä–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            const compose = document.getElementById('composeInput').value.trim();
            const proxy = document.getElementById('proxyInput').value.trim();
            
            const requestBody = { message: message };
            if (compose) requestBody.compose = compose;
            if (proxy) requestBody.compose_proxy = proxy;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                loading.classList.remove('show');
                sendButton.disabled = false;

                if (data.error) {
                    addMessage('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'agent');
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                    const responseText = data.formatted ? data.formatted.content.text : data.response;
                    addMessage(responseText, 'agent');
                }
            })
            .catch(error => {
                loading.classList.remove('show');
                sendButton.disabled = false;
                addMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message, 'agent');
            });
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            
            if (sender === 'agent' && text.includes('üéØ')) {
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞
                bubble.innerHTML = formatAgentResponse(text);
                bubble.className += ' formatted-text';
            } else {
                bubble.textContent = text;
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatAgentResponse(text) {
            // –ó–∞–º–µ–Ω—è–µ–º markdown –Ω–∞ HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function toggleRagFields() {
            const ragFields = document.getElementById('ragFields');
            if (ragFields.style.display === 'none') {
                ragFields.style.display = 'block';
            } else {
                ragFields.style.display = 'none';
            }
        }

        function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const uploadStatus = document.getElementById('uploadStatus');

            if (files.length === 0) {
                uploadStatus.textContent = '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏';
                return;
            }

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            uploadStatus.textContent = 'üì§ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª—ã...';

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    uploadStatus.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.count} —Ñ–∞–π–ª–æ–≤`;
                    fileInput.value = ''; // –û—á–∏—â–∞–µ–º input
                } else {
                    uploadStatus.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }
            })
            .catch(error => {
                uploadStatus.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
            });
        }
    </script>
</body>
</html>
