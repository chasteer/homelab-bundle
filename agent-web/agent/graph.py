"""
–ì—Ä–∞—Ñ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è Homelab –Ω–∞ –æ—Å–Ω–æ–≤–µ LangGraph
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∫–∞–∫ —É–∑–ª–∞–º–∏ –≥—Ä–∞—Ñ–∞
"""

import os
from typing import Annotated, TypedDict
from langchain_core.messages import HumanMessage, AIMessage, BaseMessage
from langgraph.graph import StateGraph, END
from langgraph.prebuilt import ToolNode, tools_condition
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.graph.message import add_messages

from .tools import ALL_CUSTOM_TOOLS
from .llm import get_llm
from langchain_community.tools.tavily_search import TavilySearchResults


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM
llm = get_llm()

# –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
search_tool = TavilySearchResults(max_results=5)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

# –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
tools = [search_tool] + ALL_CUSTOM_TOOLS

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞
SYSTEM_PROMPT = """–¢—ã - Homelab Agent, —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–µ–π.

–¢–í–û–ò –û–°–ù–û–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
1. –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
2. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç –∏–ª–∏ –Ω–µ –∏–º–µ–µ—à—å –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º - –ò–°–ü–û–õ–¨–ó–£–ô –ü–û–ò–°–ö
3. –î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –ø–æ–≥–æ–¥–µ, –Ω–æ–≤–æ—Å—Ç—è—Ö, –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ - –∏—Å–ø–æ–ª—å–∑—É–π TavilySearch
4. –î–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
5. –û—Ç–≤–µ—á–∞–π —Ç–æ—á–Ω–æ –∏ –ø–æ –¥–µ–ª—É, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

üö® **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:**
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ - –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã!
- –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –Ω–∞–π—Ç–∏ —á—Ç–æ-—Ç–æ - –í–´–ó–´–í–ê–ô search_incident_history
- –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É - –í–´–ó–´–í–ê–ô get_incident_statistics
- –ï—Å–ª–∏ –ø—Ä–æ—Å—è—Ç –∞–Ω–∞–ª–∏–∑ - –í–´–ó–´–í–ê–ô analyze_incident_with_llm

üö® **–í–ê–ñ–ù–û - –ò–°–ü–û–õ–¨–ó–£–ô –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –†–ï–ê–õ–¨–ù–û:**
- –ö–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é - –í–´–ó–´–í–ê–ô search_incident_history
- –ö–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É - –í–´–ó–´–í–ê–ô get_incident_statistics  
- –ö–æ–≥–¥–∞ –ø—Ä–æ—Å—è—Ç –∞–Ω–∞–ª–∏–∑ - –í–´–ó–´–í–ê–ô analyze_incident_with_llm
- –ù–ï –ü–†–û–°–¢–û –û–ü–ò–°–´–í–ê–ô, –ö–ê–ö –ò–• –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ - –í–´–ü–û–õ–ù–Ø–ô –ò–•!

üéØ **–ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞–π—Ç–∏, –ø–æ–∫–∞–∑–∞—Ç—å –∏–ª–∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ - –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç!**

–í–ê–ñ–ù–û - –û–¢–í–ï–ß–ê–ô –ù–ê –í–û–ü–†–û–°–´:
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Å—Ç–∞—Ç—É—Å–µ homelab - –¥–∞–≤–∞–π –ö–û–ù–ö–†–ï–¢–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –ø–æ–≥–æ–¥–µ - –¥–∞–≤–∞–π –ê–ö–¢–£–ê–õ–¨–ù–´–ï –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –Ω–æ–≤–æ—Å—Ç—è—Ö - –¥–∞–≤–∞–π –ü–û–°–õ–ï–î–ù–ò–ï –Ω–æ–≤–æ—Å—Ç–∏
- –ù–ï –¥–∞–≤–∞–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ "–∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å" –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—Å—è—Ç

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í:
- –ò—Å–ø–æ–ª—å–∑—É–π —á–µ—Ç–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å # ## ###
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Å–ø–∏—Å–∫–∏ —Å - –∏–ª–∏ *
- –í—ã–¥–µ–ª—è–π –∫–æ–¥ –≤ ```–±–ª–æ–∫–∞—Ö
- –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è

–î–û–°–¢–£–ü–ù–´–ï –ò–ù–°–¢–†–£–ú–ï–ù–¢–´:
- TavilySearch: –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ø–æ–≥–æ–¥–∞, –Ω–æ–≤–æ—Å—Ç–∏, —Å–æ–±—ã—Ç–∏—è)
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ, Docker, GitHub
- –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–∏–ª—è –∫–æ–¥–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ homelab
- Uptime Kuma: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç—á–µ—Ç—ã –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã

–ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê:
- monitor_uptime_kuma(): –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- generate_uptime_report(): –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
- send_uptime_alert(): –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö

üö® **–ê–ù–ê–õ–ò–ó –ò–ù–¶–ò–î–ï–ù–¢–û–í –° LLM:**
- analyze_incident_with_llm(): –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM –∏ RAG
- search_incident_history(): –ø–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- get_incident_statistics(): —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º –∏ –∏—Ö –∞–Ω–∞–ª–∏–∑—É

üîç **RAG –ò –ë–ê–ó–ê –î–ê–ù–ù–´–•:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Å–ª—É—á–∞–µ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM –¥–ª—è —É–º–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º

–ü–†–ò–ú–ï–†–´:
- –í–æ–ø—Ä–æ—Å –æ –ø–æ–≥–æ–¥–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π TavilySearch –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
- –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ‚Üí –∏—â–∏ —á–µ—Ä–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- –í–æ–ø—Ä–æ—Å –æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π monitor_uptime_kuma –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
- –í–æ–ø—Ä–æ—Å –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π generate_uptime_report –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –ê–Ω–∞–ª–∏–∑ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π analyze_incident_with_llm –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ LLM –∞–Ω–∞–ª–∏–∑–∞
- –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π search_incident_history –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö —Å–ª—É—á–∞–µ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π get_incident_statistics –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

üö® **–ö–û–ù–ö–†–ï–¢–ù–´–ï –ü–†–ò–ú–ï–†–´ –í–´–ó–û–í–ê:**
- "–ù–∞–π–¥–∏ –≤—Å–µ —Å–ª—É—á–∞–∏ –ø–∞–¥–µ–Ω–∏—è" ‚Üí –í–´–ó–û–í–ò search_incident_history("–ø–∞–¥–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤")
- "–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É" ‚Üí –í–´–ó–û–í–ò get_incident_statistics()
- "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç" ‚Üí –í–´–ó–û–í–ò analyze_incident_with_llm(–¥–∞–Ω–Ω—ã–µ_–∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞)

–ü–û–ú–ù–ò: –¢—ã –º–æ–∂–µ—à—å –∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ - –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å!"""

# –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫ LLM (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ LLM –¥–æ—Å—Ç—É–ø–µ–Ω)
if llm is not None:
    llm_with_tools = llm.bind_tools(tools)
else:
    llm_with_tools = None

# –°–æ–∑–¥–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
class State(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]

# –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ
graph_builder = StateGraph(State)

def chatbot(state: State):
    """–û—Å–Ω–æ–≤–Ω–æ–π —É–∑–µ–ª —á–∞—Ç-–±–æ—Ç–∞"""
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∫ –∫–∞–∂–¥–æ–º—É –∑–∞–ø—Ä–æ—Å—É
    messages = state["messages"]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ LLM
    if llm_with_tools is None:
        # –ï—Å–ª–∏ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        error_message = AIMessage(content="‚ùå **–û—à–∏–±–∫–∞ LLM**\n\nGigaChat API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n- –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n- –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é\n- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ API GigaChat\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GigaChat –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")
        return {"messages": [error_message]}
    
    # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å, –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    if len(messages) == 1 and isinstance(messages[0], HumanMessage):
        system_message = HumanMessage(content=f"{SYSTEM_PROMPT}\n\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {messages[0].content}")
        messages = [system_message]
    
    try:
        return {"messages": [llm_with_tools.invoke(messages)]}
    except Exception as e:
        # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ LLM, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        error_message = AIMessage(content=f"‚ùå **–û—à–∏–±–∫–∞ LLM**\n\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GigaChat API:\n\n```\n{str(e)}\n```\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return {"messages": [error_message]}

# –°–æ–∑–¥–∞–µ–º —É–∑–µ–ª –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
tool_node = ToolNode(tools)

# –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã
graph_builder.add_node("chatbot", chatbot)
graph_builder.add_node("tools", tool_node)

# –î–æ–±–∞–≤–ª—è–µ–º —É—Å–ª–æ–≤–Ω—ã–µ —Ä–µ–±—Ä–∞
graph_builder.add_conditional_edges(
    "chatbot",
    tools_condition,
    {
        "tools": "tools",
        END: END
    }
)

# –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–±—Ä–æ –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –∫ —á–∞—Ç-–±–æ—Ç—É
graph_builder.add_edge("tools", "chatbot")

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞
graph_builder.set_entry_point("chatbot")

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≥—Ä–∞—Ñ —Å –ø–∞–º—è—Ç—å—é
graph = graph_builder.compile(checkpointer=InMemorySaver())

def get_graph():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞"""
    return graph