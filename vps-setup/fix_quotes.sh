#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–≤—ã—á–µ–∫ –≤ .env —Ñ–∞–π–ª–µ
# –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –Ω–∞ VPS —Å–µ—Ä–≤–µ—Ä–µ

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–≤—ã—á–µ–∫ –≤ .env —Ñ–∞–π–ª–µ"
echo "=================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f ".env" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏–∑ env.example"
    exit 1
fi

echo "üìù –¢–µ–∫—É—â–∏–π .env —Ñ–∞–π–ª:"
echo "---------------------"
cat .env
echo "---------------------"

# –°–æ–∑–¥–∞–µ–º backup
cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω"

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏
echo ""
echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è—é –∫–∞–≤—ã—á–∫–∏..."

# –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∫–∞–≤—ã—á–∫–∏ –∏–∑ TELEGRAM_CHAT_ID
sed -i 's/^TELEGRAM_CHAT_ID="\([^"]*\)"$/TELEGRAM_CHAT_ID=\1/' .env

# –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∫–∞–≤—ã—á–∫–∏ –∏–∑ TELEGRAM_BOT_TOKEN
sed -i 's/^TELEGRAM_BOT_TOKEN="\([^"]*\)"$/TELEGRAM_BOT_TOKEN=\1/' .env

echo "‚úÖ –ö–∞–≤—ã—á–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"

echo ""
echo "üìù –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π .env —Ñ–∞–π–ª:"
echo "--------------------------"
cat .env
echo "--------------------------"

echo ""
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é –≤–µ–±-—Å–µ—Ä–≤–µ—Ä..."
sudo systemctl restart nginx
sudo systemctl restart php8.2-fpm

echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
php test_telegram.php

echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É—é –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏–π..."
php test_message_length.php

echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É—é –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è..."
php test_long_message.php

echo ""
echo "üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
php test_all.php

echo ""
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìã –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:"
echo "1. –õ–æ–≥–∏ nginx: sudo tail -f /var/log/nginx/error.log"
echo "2. –õ–æ–≥–∏ php-fpm: sudo tail -f /var/log/php8.2-fpm.log"
echo "3. –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: tail -f logs/homelab-vps.log"
